---
title: Gerenciamento de falta de memória no Firefox OS
slug: Archive/B2G_OS/Platform/Out_of_memory_management_on_Firefox_OS
tags:
  - Firefox OS
  - Gerenciamento de memória
  - LMK
  - Pouca Memória
  - oom_adj
translation_of: Archive/B2G_OS/Platform/Out_of_memory_management_on_Firefox_OS
---
<div class="summary">
 <p><span class="seoSummary">O Firefox OS roda em alguns dispositivos com baixa capacidade de memória, e é fácil que estes aplicativos esgotem a memória em tais sistemas. Quando um processo esgota a memória disponível do sistema, o kernel deve encerrar alguns processos para liberar memória. Este artigo descreve como o "low memory killer" e "low memory notifications" funcionam — os dois sistemas no dispositivo controlam quais processos devem ser encerrados para manter o sistema principal funcionando sem que ele fique sem memória.</span></p>
</div>
<p>FxOS funciona com vários processos envolvidos — um "processo principal" que executa os serviços básicos do sistema e potencialmente muitos "processos filhos". Em geral todo aplicativo é executado em seu próprio processo filho. Uma vez que as aplicações do ambiente FxOS são raramente fechadas pelo usuário, o sistema automaticamente gerencia o tempo de vida para liberar mais espaço para novas aplicações ou para aplicações que estejam sendo executadas e que necessitem mais espaço de memória.</p>
<p>Dois subsistemas são usados para gerenciar isto: o <strong>Low memory killer (LMK </strong><span style="line-height: 1.5;">—</span><strong style="line-height: 1.5;"> Finalizador de</strong><strong style="line-height: 1.5;"> memória </strong><strong style="line-height: 1.5;">baixa)</strong><span style="line-height: 1.5;"> e </span><strong style="line-height: 1.5;">Low memory notifications (Notificações de pouca memória)</strong><span style="line-height: 1.5;">.</span></p>
<h2 id="Low_memory_killer">Low memory killer</h2>
<p><a href="https://android.googlesource.com/kernel/common.git/+/edd540ea92954f896bfb7ee0ebf5dfdde6e6cb41/drivers/staging/android/lowmemorykiller.txt">O LMK</a> é um subsistema do kernel do Android que encerra automaticamente os processos  para dar lugar a pedidos de memória. Para escolher qual o processo deve ser encerrado primeiro para liberar memória, a cada processo é atribuido uma prioridade através dos arquivos <a href="https://www.kernel.org/doc/Documentation/filesystems/proc.txt">/proc/&lt;pid&gt;/oom_adj ou /proc/&lt;pid&gt;/oom_score_adj</a>. Um processos tem uma prioridade conhecida como prontuação de ajuste, ou <code>oom_adj</code>.  Valores menores de <code>oom_adj</code> corresponde a processos de maior prioridade.</p>
<p>Em geral, quanto maior for a pontuação de ajuste, maior a probabilidade de ser o escolhido para ser encerrado. O LMK oferece múltiplos níveis, cada um correspondendo a uma certa quantidade de memória livre e uma mínima de pontuação de ajuste. Sempre que a quantidade de memória livre no sistema cair abaixo de um certo nível, todos os processos com uma pontuação de ajuste maior do que o mínimo especificado para este nível são elegíveis para ser encerrado. O LMK irá começar a encerrar esses processos, os maiores em primeiro lugar, e continuará até que tenha liberado memória suficiente de acordo com o limite definido.</p>
<div class="note">
 <p><strong>Nota</strong>: O processo encerrado quando o dispositivo ficar sem memória não é necessariamenteo que "causou" a condição de falta de memória.</p>
</div>
<h3 id="Prioridades_de_processos">Prioridades de processos</h3>
<p>No Firefox OS os aplicativos são encerrados seguindo a política de ordem de prioridade, que é imposta dando a cada aplicação um nível de prioridade e associando uma pontuação de ajuste (OOM) a esses níveis.<span style="line-height: 1.5;"> (</span><a href="http://hg.mozilla.org/mozilla-central/file/545c35907eff/b2g/app/b2g.js#l661" style="line-height: 1.5;">os valores correntes são definidos em prefs</a><span style="line-height: 1.5;">):</span></p>
<ol>
 <li>Os primeiros aplicativos a serem encerrados serão os aplicativos em segundo plano, iniciando pelos menos utilizados recentemente.</li>
 <li><span style="line-height: 1.5;">O aplicativo homescreen é o próximo a ser encerrado.</span></li>
 <li>Em seguida, são encerrados os aplicativos em segundo plano que são perceptíveis pelo usuário (por exemplo, um leitor de música reproduzindo áudio em segundo plano ou um aplicativo que possua um <em>wakelock</em> de <code style="font-style: normal; line-height: 1.5;">high-priority</code><span style="line-height: 1.5;"> ou </span><code style="font-style: normal; line-height: 1.5;">cpu</code><span style="line-height: 1.5;">  e ter um manipulador de mensagens de sistema registrado.)</span></li>
 <li>Se o teclado estiver em uso, será o próximo a ser encerrado.</li>
 <li>Aplicações em primeiro plano serão as próximas a serem encerradas.</li>
 <li>Finalmente, aplicações em primeiro plano que solicitaram um wakelock <span style="line-height: 1.5;"> </span><code style="font-style: normal; line-height: 1.5;">high-priority</code><span style="line-height: 1.5;"> ou </span><code style="font-style: normal; line-height: 1.5;">cpu</code><span style="line-height: 1.5;"> serão as últimas a serem encerradas</span>.</li>
</ol>
<div class="note">
 <p><strong>Nota</strong>: Muitos "processos filhos" são executados com <code>oom_adj 2</code> enquanto estão em primeiro plano. Ao serem executados em segundo plano o valor de <code>oom_adj</code> ficam entre <code>3</code> e <code>6</code> (inclusive).  O valor exato de <code>oom_adj</code> de um processo filho depende de vários de fatores: se está tocando uma música, se é o aplicativo de tela inicial, etc.</p>
</div>
<p>Existe algumas excessões para essas regras:</p>
<ul>
 <li>O processo principal nunca é terminado pelo LMK, pois se isso for feito todos os demais processos serão terminados e o sistema operacional seria reiniciado. O processo principal é executado com <code>oom_adj 0</code>.</li>
 <li>Nós mantemos um processo que é utilizado para acelear o início de novos aplicativos chamado <strong>preallocated process</strong>. Normalmente esse processo é mantido ativo pois consome pouca memória e permite uma maior velocidade ao iniciar um aplicativo. A única situação na qual esse processo pode ser terminado é se não existir memória suficiente para o processo principal manter-se ativo após os outros processos terem sido terminados.</li>
</ul>
<h2 id="Low_memory_notifications">Low memory notifications</h2>
<p>O segundo mecanismo utilizado para liberar memória é a Notificação de pouca memória ou Low memory notifications. O LMK fornece um <a href="https://www.codeaurora.org/cgit/quic/la//kernel/msm/commit/?id=b3f986cba580b14438b77b42070ebbc77b69d4c4">limite especial</a> que quando ultrapassado pode enviar notificações para o <em>userspace</em> informando que o sistema está sendo executado com pouca memória. Tanto os aplicativos de sistema quanto os aplicativos regulares estão projetados para reagir ao evento <code>memory-pressure</code> via o serviço observer. Esse evento é visível apenas por códigos C++ e chrome JS e não diretamente pela aplicação. Através do codebase do Gecko nós usamos esse evento para liberar a maior quantidade de memória possível — normalmente purgando caches internos (imagens, DNS, sqlite, etc), descartando objetos que podem ser recriados (contextos WebGL por example) e executando o <em>garbage collector</em> e <em>cycle collector</em>.<br>
 <br>
 Quando for encontrada uma condição de pouca memória o primeiro evento <code>memory-pressure</code> enviado possuirá o parâmetro <code>low-memory</code>. Se após um período pré-definido (5s) persistir a condição de pouca memória, um outro evento <code>memory-pressure</code> será disparado, mas dessa vez com o parâmetro <code>low-memory-ongoing</code>. Esse parâmetro é utilizado quando continuamos com a condição de pouca memória e gostaríamos de liberar caches e utlizar outras formas "mais baratas" de minimizar o uso da memória, mas sabendo que abordagens mais pesadas como GC (Garbage Collector) provavelmente não terão sucesso.</p>
<h2 id="Como_LMK_e_as_notificações_de_pouca_memória_trabalham_juntos">Como LMK e as notificações de pouca memória trabalham juntos</h2>
<p>Atualmente o <a href="http://hg.mozilla.org/mozilla-central/file/545c35907eff/b2g/app/b2g.js#l722">limite de pouca memória é definido abaixo do nível do LMK para aplicativos em segundo plano mas abaixo de um para a tela inicial</a>. Assim, as ações  agregadas para o LMK e notificação de pouca memória quando um dispositivo possui pouca memória:</p>
<ol>
 <li>Terminar aplicativos em segundo plano em ordem dos menos usados recentemente.</li>
 <li>Se não for liberada memória suficiente envia o evento <code>memory-pressure</code> para os aplicativos remanescentes.</li>
 <li>Se a condição persistir é renviado um evento <code>memory-pressure</code> a cada 5 segundos, mas marcando-os como em execução para que os processos de GC/CC (Garbage Collector e Cycle Collector) não respondam a eles.</li>
 <li>Terminar o aplicativo Tela Inicial.</li>
 <li>Terminar aplicações em segundo plano perceptíveis e de alta prioridade.</li>
 <li>Terminar o aplicativo teclado se estiver sendo executado.</li>
 <li>Terminar aplicativos em primeiro plano.</li>
 <li>Terminar aplicativos em primeiro plano de alta prioridade.</li>
 <li>Terminar os processos pré-alocados.</li>
</ol>
