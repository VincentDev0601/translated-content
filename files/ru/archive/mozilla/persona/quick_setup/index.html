---
title: Быстрая установка
slug: Archive/Mozilla/Persona/Quick_Setup
tags:
  - Persona
  - Использование
  - Настройка
  - Пример
  - Установка
translation_of: Archive/Mozilla/Persona/Quick_Setup
---
<p>Добавление системы авторизации Persona на ваш сайт займет всего 5 шагов:</p>
<ol>
 <li>Подключите ЯваСкрипт-библиотеку на ваши страницы.</li>
 <li>Добавьте кнопки «Вход» и «Выход».</li>
 <li>Отслеживайте события входа и выхода.</li>
 <li>Проверьте учетные данные пользователя.</li>
 <li>Ознакомьтесь с лучшими примерами.</li>
</ol>
<p>Установка и настройка займёт у вас всего один вечер, но если вы собираетесь использовать Persona на вашем сайте, <em>пожалуйста</em>, прежде всего уделите минутку и подпишитесь на рассылку <a href="https://mail.mozilla.org/listinfo/persona-notices">Заметки о Persona</a>. Там крайне мало сообщений, она используется только для анонсов изменений или проблем с безопасностью, которые могут неблагоприятно сказаться на работе вашего сайта.</p>
<h2 id="Шаг_1_Подключение_библиотеки">Шаг 1: Подключение библиотеки</h2>
<p>Persona разработана так, чтобы быть независимой от обозревателя и хорошо работает во <a href="https://developer.mozilla.org/docs/persona/Browser_compatibility">всех основных настольных и мобильных обозревателях</a>. Это возможно благодаря межплатформенной библиотеке Persona, написанной на ЯваСкрипте. После того, как библиотека загружена на вашей странице, вам потребуются следующие функции Persona: ({{ domxref("navigator.id.watch()", "watch()") }}, {{ domxref("navigator.id.request()", "request()") }}, и {{ domxref("navigator.id.logout()", "logout()") }}), которые будут доступны в глобальном объекте <code>navigator.id</code>.</p>
<p>Чтобы подключить ЯваСкрип-библиотеку Persona, поместите следующий код в головной ярлык head:</p>
<pre class="brush: html;">&lt;script src="https://login.persona.org/include.js"&gt;&lt;/script&gt;
</pre>
<p>Вы должны подключить эту библиотеку, так как она создает функции {{ domxref("navigator.id") }}. Потому, что Persona еще находится в разработке, вы не должны самостоятельно изменять файл <code>include.js</code>.</p>
<h2 id="Шаг_2_Добавление_кнопок_входа_и_выхода">Шаг 2: Добавление кнопок входа и выхода</h2>
<p>Потому, что Persona создана как DOM API, Вы должны вызывать функции, когда пользователь нажимает на кнопки входа и выхода на Вашем сайте. Чтобы открыть окно входа через Persona, вызовите функцию {{ domxref("navigator.id.request()") }}. Для выхода вызовите {{ domxref("navigator.id.logout()") }}.</p>
<p>Например:</p>
<pre class="brush: js;">var signinLink = document.getElementById('signin');
if (signinLink) {
  signinLink.onclick = function() { navigator.id.request(); };
};

var signoutLink = document.getElementById('signout');
if (signoutLink) {
  signoutLink.onclick = function() { navigator.id.logout(); };
};
</pre>
<p>Как выглядят эти кнопки? Посмотрите <a href="https://developer.mozilla.org/docs/persona/branding">эту страницу</a>, там найдете CSS и изображения!</p>
<h2 id="Шаг_3_Отслеживание_событий_входа_и_выхода">Шаг 3: Отслеживание событий входа и выхода</h2>
<p>Для работы Persona вы должны сообщить ей, что делать, когда пользователь осуществляет вход и выход. Для этого нужно вызвать функцию {{ domxref("navigator.id.watch()") }}, предоставив ей три параметра:</p>
<ol>
 <li>
  <p><code>loggedInEmail</code> – почта текущего пользователя на сайте или <code>null</code>, если его нет. Это значение должно формироваться динамически во время создания страницы.</p>
 </li>
 <li>
  <p>Функцию, которую следует вызвать при входе пользователя – действие <code>onlogin</code>. Это функция должна принимать один параметр – "заявленный идентификатор", который должен быть проверен.</p>
 </li>
 <li>
  <p>Функцию, которую следует вызвать при выходе пользователя – действие <code>onlogout</code>. Эта функция работает без каких-либо параметров.</p>
 </li>
</ol>
<div class="note style-wrap">
 <p><strong>Замечание:</strong> Необходимо всегда указывать обе функции (для входа и выхода) – <code>onlogin</code> и <code>onlogout</code> при вызове {{ domxref("navigator.id.watch()") }}.</p>
</div>
<p>Например, если вы думаете что Иван выполнил вход на ваш сайт, вы должны сделать следующее:</p>
<pre class="brush: js;">var currentUser = 'ivan@example.com';

navigator.id.watch({
  loggedInEmail: currentUser,
  onlogin: function(assertion) {
    // Пользователь выполнил вход! В этом случае нужно:
    // 1. Отправить заявленный идентификатор в бекэнд вашего сайта (серверная часть, прим. переводчика) для проверки и создания сессии.
    // 2. Обновить интерфейс пользователя.
    $.ajax({
      type: 'POST',
      url: '/auth/login', // это URL путь на вашем сайте.
      data: {assertion: assertion},
      success: function(res, status, xhr) { window.location.reload(); },
      error: function(res, status, xhr) { alert("login failure" + res); }
    });
  },
  onlogout: function() {
    // Пользователь выполнил выход! В этом случае нужно:
    // Удалить сессию пользователя с помощью перенаправления или отправки запроса на бекэнд.
    $.ajax({
      type: 'POST',
      url: '/auth/logout', // это URL путь на вашем сайте.
      success: function(res, status, xhr) { window.location.reload(); },
      error: function(res, status, xhr) { alert("logout failure" + res); }
    });
  }
});
</pre>
<p>В этом примере обе функции <code>onlogin</code> и <code>onlogout</code> отправляют асинхронные <code>POST</code> запросы к бекэнду вашего сайта. Бекэнд в свою очередь осуществляет процедуру входа и выхода пользователя, записывая или удаляя информацию в куки сессии. Далее, если пройдены все проверки, страница перезагружается, отображая новое состояние авторизации.</p>
<p>Вы, конечно, можете использовать AJAX, чтобы реализовать всё без перезагрузки страницы или перенаправлений, однако это не входит в рамки данного учебника.</p>
<p>Эту функцию <strong>обязательно</strong> вызывать на каждой странице, где есть кнопки входа или выхода. Чтобы ваши пользователи могли использовать такие возможности как автоматический вход или глобальный выход из системы, <strong>требуется</strong> вызывать эту функцию на каждой странице вашего сайта.</p>
<h2 id="Шаг_4_Проверка_пользовательских_данных">Шаг 4: Проверка пользовательских данных</h2>
<p>Вместо паролей Persona использует "заявленные идентификаторы", которые представляют из себя что-то вроде одноразовых паролей только для одного сайта, связанных с адресом электронной почты пользователя. Когда пользователь собирается осуществить вход, будет вызвана ваша функция <code>onlogin</code> с "заявкой" от пользователя. Прежде чем закончить процедуру входа вы должны проверить эту заявку.</p>
<p><em>Крайне важно</em> осуществлять такую проверку на стороне сервера, но не с помощью ЯваСкрипт-кода, работающего в обозревателе пользователя, иначе её легко можно подделать. В следующем примере заявка передаётся на сервер методом <code>POST</code> на адрес <code>/api/login</code> с помощью вспомогательной функции jQuery <code>$.ajax()</code>.</p>
<p>Как следует делать проверку на сервере при получении заявки? Самый простой способ – использовать службу, предоставляемую Mozilla. Просто отправьте <code>POST</code> запрос с заявкой на адрес <code>https://verifier.login.persona.org/verify</code> указав два параметра:</p>
<ol>
 <li><code>assertion</code>: заявка-идентификатор, полученный от пользователя.</li>
 <li><code>audience</code>: Адрес хоста и порт вашего сайта. Это информация должна быть записана в вашем бекэнде, ни в коем случае не получайте эти данные из того, что было отправлено пользователем.</li>
</ol>
<p>Предположим, <code>example.com</code> – это адрес вашего сайта, вы сможете проверить заявку, используя командную строку:</p>
<pre class="brush: bash;">$ curl -d "assertion=&lt;ASSERTION&gt;&amp;audience=https://example.com:443" "https://verifier.login.persona.org/verify"
</pre>
<p>Если она настоящая, в ответ вы получите примерно такой ответ в формате JSON:</p>
<pre class="brush: js;">{
  "status": "okay",
  "email": "bob@eyedee.me",
  "audience": "https://example.com:443",
  "expires": 1308859352261,
  "issuer": "eyedee.me"
}
</pre>
<p>Вы можете более подробно ознакомиться со службой проверки, прочитав статью <a href="https://developer.mozilla.org/en-US/docs/BrowserID/Remote_Verification_API">API Проверочной Службы</a>. Примерная реализация <code>/api/login</code>, с использованием <a href="http://python.org/">Питона</a>, веб-фреймворка <a href="http://flask.pocoo.org/">Flask</a>, и HTTP-библиотеки <a href="http://python-requests.org">Requests</a>, может выглядеть так:</p>
<pre class="brush: python;">@app.route('/api/login', methods=['POST'])
def login():
    # Запрос должен содержать заявку, которую нам нужно проверить
    if 'assertion' not in request.form:
        abort(400)

    # Отправляем заявку в службу проверки Mozilla.
    data = {'assertion': request.form['assertion'], 'audience': 'https://example.com:443'}
    resp = requests.post('https://verifier.login.persona.org/verify', data=data)

    # Получен ли от службы ответ?
    if resp.ok:
        # Разбираем ответ
        verification_data = json.loads(resp.content)

        # Проверяем, верна ли заявка?
        if verification_data['status'] == 'okay':
            # Осуществляем вход пользователя, устанавливая защищённую куки сессии
            session.update({'email': verification_data['email']})
            return resp.content

    # Что-то пошло не так! Отмена.
    abort(500)
</pre>
<p>Управление сессиями, вероятно, очень похоже на систему авторизации, которую вы уже используете. Первое основное отличие при проверке идентификатора пользователя в том, что вместо проверки пароля происходит проверка заявки. Второе большое отличие – проверка того, что адрес электронной почты пользователя корректный, путём передачи его в качестве параметра <code>loggedInEmail</code> функции {{ domxref("navigator.id.watch()") }}.</p>
<p>Выход из системы прост: всё, что нужно – удалить куки сессии пользователя.</p>
<h2 id="Шаг_5_Обзор_лучших_примеров">Шаг 5: Обзор лучших примеров</h2>
<p>После того, как всё заработает и вы успешно сможете осуществлять вход и выход на своём сайте, вы можете уделить немного времени, чтобы ознакомиться с <a href="https://developer.mozilla.org/docs/BrowserID/Security_Considerations">лучшими примерами</a> безопасного и защищённого использования Persona.</p>
<p>Возможно, вы захотите написать интеграционные тесты, которые симулируют вход и выход пользователя используя BrowserID, если вы делает сайт, готовый к запуску. Чтобы облегчить этот процесс c Selenium, обратите внимание на библиотеку <a href="https://github.com/mozilla/bidpom" title="https://github.com/mozilla/bidpom">bidpom</a>. Так же может оказаться полезным сайт <a href="http://personatestuser.org" title="http://personatestuser.org">personatestuser.org</a>.</p>
<p>Ну и напоследок, не забудьте подписаться на рассылку <a href="https://mail.mozilla.org/listinfo/persona-notices">Заметки о Persona</a>, так вы всегда будете в курсе любых проблем безопасности, а также об обратно несовместимых изменениях в API Persona. Рассылка не будет обременять вас – она используется исключительно для объявлений изменений, которые могут неблагоприятно сказаться на вашем сайте.</p>
<p> </p>
