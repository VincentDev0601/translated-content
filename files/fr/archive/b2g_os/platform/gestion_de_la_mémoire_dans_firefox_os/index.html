---
title: Gestion de la mémoire dans Firefox OS
slug: Archive/B2G_OS/Platform/Gestion_de_la_mémoire_dans_Firefox_OS
translation_of: Archive/B2G_OS/Platform/Out_of_memory_management_on_Firefox_OS
---
<div class="summary">
<p><span id="result_box" lang="fr"><span class="hps">Firefox</span> <span class="hps">OS fonctionne</span> <span class="hps">sur certains appareils</span> <span class="hps">sévèrement</span> <span class="hps">limités en mémoire</span><span>,</span> <span class="hps">et il est facile</span> <span class="hps">pour les applications</span> <span class="hps">d'épuiser</span> <span class="hps">la mémoire disponible</span> <span class="hps">sur de tels systèmes</span><span>.</span> <span class="hps">Quand un processus</span> <span class="hps">épuise</span> <span class="hps">la mémoire disponible sur</span> <span class="hps">le système</span><span>,</span> <span class="hps">le noyau</span> <span class="hps">doit "tuer"</span> <span class="hps">d'autres</span> <span class="hps">processus afin de</span> <span class="hps">libérer de la mémoire</span><span>.</span> <span class="hps">Cet article explique comment</span> </span>low memory killer and low memory notifications<span lang="fr"> <span class="hps">travaillent</span> <span class="hps">-</span> <span class="hps">les</span> <span class="hps">deux</span> <span class="hps">systèmes</span> <span class="hps">sur</span> <span class="hps">le dispositif</span> <span class="hps">qui contrôlent</span> <span class="hps">ce</span> <span class="hps">processus</span> <span class="hps">sont tués</span> <span class="hps">pour maintenir le système</span> <span class="hps">principale en cours d'exécution</span> <span class="hps">quand il</span> <span class="hps">est à court de</span> <span class="hps">mémoire.</span></span></p>
</div>

<p><span id="result_box" lang="fr"><span class="hps">Une opération Firefox</span> <span class="hps">OS</span> <span class="hps">implique</span> <span class="hps">plusieurs processus</span> <span class="hps">-</span> <span class="hps">un</span> <span class="atn hps">"</span><span>processus principal</span><span>"</span> <span class="hps">exécutant des services</span> <span class="hps">de base du système</span><span>,</span> <span class="hps">et potentiellement</span> <span class="hps">de nombreux</span> <span class="atn hps">"</span><span>processus</span> <span class="hps">enfants"</span><span>.</span> <span class="hps">En général</span> <span class="hps">chaque</span> <span class="hps">application</span> <span class="hps">fonctionne</span> <span class="hps">dans son propre processus</span> <span class="hps">enfant</span><span>.</span> <span class="hps">Parce que</span> <span class="hps">dans les</span> <span class="hps">applications de l'environnement</span> <span class="hps">Firefox</span> <span class="hps">OS</span> <span class="hps">sont rarement</span> <span class="hps">fermée par</span> <span class="hps">l'utilisateur</span>,  <span class="hps">le système</span> <span class="hps">gère automatiquement</span> <span class="hps">leur durée de vie</span> <span class="hps">pour faire place à</span> <span class="hps">de nouvelles applications</span> <span class="hps">ou des</span> <span class="hps">applications</span> <span class="hps">existantes</span> <span class="hps">nécessitant</span> <span class="hps">de la mémoire supplémentaire</span><span>.</span></span></p>

<p><span id="result_box" lang="fr"><span class="hps">Deux</span> <span class="hps">sous-systèmes</span> <span class="hps">sont utilisés pour gérer</span> <span class="hps">ceci</span></span>: le <strong>Low memory killer (LMK)</strong> et le<strong> Low memory notifications</strong>.</p>

<h2 id="Low_memory_killer">Low memory killer</h2>

<p><span id="result_box" lang="fr"><span class="hps">Le</span> <span class="hps">LMK</span> <span class="hps">est</span> <span class="hps">un sous-système</span> <span class="hps">du noyau</span> <span class="hps">Android</span> <span class="hps">qui tue</span> <span class="hps">automatiquement les processus</span> <span class="hps">pour faire place à</span> <span class="hps">des demandes de mémoire</span><span>.</span> <span class="hps">Afin de choisir</span> <span class="hps">quel processus est</span> <span class="hps">tué</span> <span class="hps">d'abord pour</span> <span class="hps">libérer de la mémoire</span><span>,</span> <span class="hps">chaque processus</span> <span class="hps">est assignée</span> <span class="hps">une priorité</span> <span class="hps">par l'intermédiaire des </span></span><a href="https://www.kernel.org/doc/Documentation/filesystems/proc.txt">fichiers /proc/&lt;pid&gt;/oom_adj ou /proc/&lt;pid&gt;/oom_score_adj</a>. <span id="result_box" lang="fr"><span class="hps">La priorité d'un</span> <span class="hps">processus est connu comme</span> <span class="hps">son score</span> <span class="hps">d'ajustement </span></span>, ou <code>oom_adj</code>.  Les plus petites valeurs de <code>oom_adj</code> correspondent <span class="short_text" id="result_box" lang="fr"><span class="hps">à des processus</span> <span class="hps">de priorité supérieure.</span></span></p>

<p><span id="result_box" lang="fr"><span class="hps">En</span> <span class="hps">général, plus</span> <span class="hps">le score</span> <span class="hps">d'ajustement </span></span><span lang="fr"><span class="hps"> est</span><span> élévé,</span> <span class="hps">plus le</span> <span class="hps">processus</span> <span class="hps">est</span> <span class="hps">susceptible</span> <span class="hps">d'être tué</span><span>.</span> <span class="hps">Le</span> <span class="hps">LMK</span> <span class="hps">offre de multiples</span> <span class="hps">niveaux, chacun</span> <span class="hps">correspondant à une certaine</span> <span class="hps">quantité de mémoire libre</span> <span class="hps">et un score</span> <span class="hps">d'ajustement </span> <span class="hps">minimum.</span> <span class="hps">Chaque fois que</span> <span class="hps">la quantité de mémoire</span> <span class="hps">libre dans le système</span> <span class="hps">tombe en dessous</span> <span class="hps">d'un</span> <span class="hps">certain seuil</span><span>,</span> <span class="hps">tous les processus</span> <span class="hps">avec</span> <span class="hps">un score d'ajustement </span><span class="hps">plus élevées</span> <span class="hps">que le minimum</span> <span class="hps">spécifié pour</span> <span class="hps">ce niveau</span> <span class="hps">sont admissibles à</span> <span class="hps">être tué</span><span>.</span> <span class="hps">Le</span> <span class="hps">LMK</span> <span class="hps">commencera à tuer</span> <span class="hps">ces processus</span><span>,</span> <span class="hps">les plus grandes</span> <span class="hps">d'abord,</span> <span class="hps">et continuera</span> <span class="hps">jusqu'à ce qu'il</span> <span class="hps">a libéré</span> <span class="hps">suffisamment de mémoire pour</span> <span class="hps">aller au-dessus</span> <span class="hps">de ce seuil</span><span>.</span></span></p>

<div class="note">
<p><span id="result_box" lang="fr"><span class="hps"><strong>Remarque</strong>:</span> <span class="hps">Quand une</span> <span class="hps">application</span> <span class="hps">de fond</span> <span class="hps">est tué</span> <span class="hps">par le</span> <span class="hps">LMK</span><span>,</span> <span class="hps">elle est mise</span> <span class="hps">dans le</span> <span class="hps">gestionnaire de tâches</span> <span class="hps">/</span> <span class="hps">à travers</span> <span class="hps">des balayages</span> <span class="hps">de bord</span> <span class="hps">comme un</span>e <span class="hps">"app</span> <span class="hps">zombie"</span><span>:</span> <span class="hps">la prochaine fois que</span> <span class="hps">vous accédez à</span> <span class="hps">cette application</span><span>,</span> <span class="hps">elle sera</span> <span class="hps">relancé</span><span>.</span> <span class="atn hps">Le nombre maximal d'</span><span>applications qui peuvent être</span> <span class="hps">maintenu dans cet état</span> <span class="hps">est actuellement de 10</span><span>.</span></span></p>
</div>

<div class="note">
<p><span id="result_box" lang="fr"><span class="hps"><strong>Remarque</strong>: Le processus</span> <span class="hps">tué</span> <span class="hps">lorsque l'appareil</span> <span class="hps">manque de mémoire</span> <span class="hps">est</span> <span class="hps">pas nécessairement</span> <span class="hps">celui qui</span> <span class="atn hps">"</span><span>a causé</span><span>"</span> <span class="hps">la condition</span> <span class="atn hps">out-of-</span><span>memory.</span></span></p>
</div>

<h3 id="Les_priorités_d'un_processus"><span class="short_text" id="result_box" lang="fr"><span class="hps">Les priorités d'un</span> <span class="hps">processus</span></span></h3>

<p><span id="result_box" lang="fr"><span class="hps">Dans Firefox</span> <span class="hps">OS les applications</span> <span class="hps">sont tués</span> <span class="atn hps">dans la politique d'</span><span>ordre de priorité suivant</span><span>,</span> <span class="hps">qui est</span> <span class="hps">appliquée</span> <span class="hps">en donnant à chaque</span> <span class="hps">demande</span> <span class="hps">un niveau de priorité</span> <span class="hps">et en associant</span> <span class="hps">un score</span> <span class="hps">d'ajustement </span><span class="hps">OOM</span> <span class="hps">à ces</span> <span class="atn hps">niveaux (</span><span>les valeurs actuelles</span> <span class="hps">sont définies dans</span> <span class="hps">prefs</span><span>)</span><span>:</span></span></p>

<ol>
 <li><span id="result_box" lang="fr"><span class="hps">Les premières</span> <span class="hps">applications</span> <span class="hps">à</span> <span class="hps">être tués</span> <span class="hps">seront les</span> <span class="hps">applications</span> <span class="hps">d'arrière-plan</span><span>,</span> <span class="hps">en commençant par le</span> <span class="hps">moins récemment utilisé</span><span>.</span></span></li>
 <li><span id="result_box" lang="fr"><span class="hps">Les applications de fond</span> <span class="hps">qui sont</span> <span class="hps">perceptibles par</span> <span class="hps">l'utilisateur</span> <span class="hps">sont tués</span> ensuite<span class="hps"> (par exemple</span><span>,</span> <span class="hps">un lecteur de musique</span> <span class="hps">lecture audio</span> <span class="hps">en arrière-plan</span> <span class="hps">ou</span> <span class="hps">une application</span> <span class="hps">tenant une</span> <span class="hps">haute</span> <span class="hps">priorité ou</span> <span class="hps">cpu</span> <span class="hps">wakelock</span> <span class="hps">et ayant un</span> <span class="hps">gestionnaire enregistré pour</span> <span class="hps">les messages du système</span><span>.</span><span>)</span></span></li>
 <li><span id="result_box" lang="fr"><span class="hps">Si</span> <span class="hps">l'application du clavier</span> <span class="hps">est en marche</span><span>, elle</span> <span class="hps">sera tué</span> <span class="hps">ensuite</span><span>.</span></span></li>
 <li><span class="short_text" id="result_box" lang="fr"><span class="hps">Les applications de premier plan</span> <span class="hps">seront tués</span> <span class="hps">ensuite</span></span>.</li>
 <li><span id="result_box" lang="fr"><span class="hps">Enfin, les applications</span> <span class="hps">de premier plan</span> <span class="hps">qui ont demandé</span> <span class="hps">à haute priorité</span> <span class="hps">ou</span> <span class="hps">cpu</span> <span class="hps">wakelocks</span> <span class="hps">sont les derniers à</span> <span class="hps">se faire tuer</span><span>.</span></span></li>
</ol>

<div class="note">
<p><span id="result_box" lang="fr"><span class="hps"><strong>Remarque</strong>:</span> <span class="hps">La plupart des</span> <span class="hps">processus</span> enfants s'exécutent<span class="hps"> avec</span> <span class="hps">oom_adj</span> <span class="hps">égale à 2</span> <span class="hps">pendant qu'ils sont</span> <span class="hps">au premier plan</span><span>.</span> <span class="hps">Les processus enfants</span> <span class="hps">à</span> <span class="hps">l'arrière-plan</span> s'exécutent<span class="hps"> </span></span><span lang="fr"><span class="hps"> avec</span> <span class="hps">oom_adj</span> <span class="hps">entre 3 et 6</span> <span class="atn hps">(</span><span>inclus)</span><span>.</span> <span class="hps">Exactement la valeur de</span> <span class="hps">oom_adj</span> <span class="hps">qu'un processus enfant</span> <span class="hps">a</span> <span class="hps">alors</span> <span class="hps">en arrière-plan</span> <span class="hps">dépend d'un</span> <span class="hps">certain nombre de facteurs</span><span>, à savoir</span> <span class="hps">que ce soit le lecteur de musique</span><span>, que ce soit</span> <span class="hps">l'application du clavier</span><span>, etc.</span></span></p>
</div>

<p><span class="short_text" id="result_box" lang="fr"><span class="hps">Il ya</span> <span class="hps">quelques</span> <span class="hps">exceptions à ces règles</span><span>:</span></span></p>

<ul>
 <li><span id="result_box" lang="fr"><span class="hps">Le processus principal</span> <span class="hps">n'est</span> <span class="hps">jamais</span> <span class="hps">tué</span> <span class="hps">par le</span> <span class="hps">LMK</span> <span class="hps">car cela</span> <span class="hps">tuerait</span> <span class="hps">tous les processus</span> <span class="hps">de l'enfant</span> <span class="hps">et </span><span class="hps">redémarrera</span> <span class="hps">le système d'exploitation</span><span>.</span> <span class="hps">Le processus principal</span> <span class="hps">fonctionne avec</span></span> <code>oom_adj 0</code>.</li>
 <li>
  <div class="almost_half_cell" id="gt-res-content">
  <div dir="ltr" style="zoom: 1;"><span id="result_box" lang="fr"><span class="hps">Nous gardons</span> <span class="hps">un processus</span> <span class="hps">autour</span> <span class="hps">pour accélérer</span> <span class="hps">le démarrage de nouvelles</span> <span class="hps">applications appelées</span> <span class="hps">le processus</span> <span class="hps">préallouée</span><span>.</span> <span class="hps">Ce processus est</span> <span class="hps">généralement toujours</span> <span class="hps">maintenu en vie</span> <span class="hps">car il consomme</span> <span class="hps">très peu de mémoire</span> <span class="hps">et accélère</span> <span class="hps">considérablement</span> <span class="hps">démarrage de l'application</span><span>.</span> <span class="hps">Le seul cas</span> <span class="hps">dans lequel il peut</span> <span class="hps">être</span> <span class="hps">tué</span> <span class="hps">est</span> <span class="hps">si</span> <span class="hps">il n'y a pas</span> <span class="hps">assez de mémoire</span> <span class="hps">disponible pour</span> <span class="hps">le processus principal</span> <span class="hps">pour continuer à fonctionner</span> <span class="hps">après avoir tué</span> <span class="hps">tous les autres processus</span><span>.</span></span></div>
  </div>
 </li>
</ul>

<h2 id="Low_memory_notifications">Low memory notifications</h2>

<p><span id="result_box" lang="fr"><span class="hps">Le second mécanisme</span> <span class="hps">que nous utilisons pour</span> <span class="hps">libérer de la mémoire</span> <span class="hps">est</span> </span><em>low memory notifications</em><span lang="fr"><span>.</span> <span class="hps">Le</span> <span class="hps">LMK</span> <span class="hps">fournit</span> <span class="hps">un seuil</span> <span class="hps">spécial qui</span><span>,</span> <span class="hps">lorsqu'on les croise</span><span>,</span> <span class="hps">peut envoyer des</span> <span class="atn hps">notifications à l'</span><span>espace utilisateur</span> <span class="hps">qui exécute</span> <span class="hps">faible sur la mémoire</span><span>.</span> <span class="hps">La fois l'application</span> <span class="hps">du système et</span> <span class="hps">des applications</span> <span class="hps">régulières</span> <span class="hps">d'utilisateurs</span> <span class="hps">attendent</span> <span class="hps">en permanence</span> <span class="hps">pour cette condition</span> <span class="hps">et</span> <span class="hps">vont réagir</span> <span class="hps">sur elle</span> <span class="atn hps">par l'envoi d'</span><span>un événement</span> <span class="hps">mémoire</span> <span class="hps">pression par l'intermédiaire</span> <span class="hps">du service</span> <span class="hps">d'observateur</span><span>.</span> <span class="hps">Cet événement</span> <span class="hps">est visible uniquement</span> <span class="hps">à</span> <span class="hps">code C ++ et</span> <span class="hps">JS</span> <span class="hps">chrome</span> <span class="hps">et non pas directement</span> <span class="hps">par une application.</span> <span class="hps">Grâce à</span> <span class="hps">la base de code</span> <span class="hps">Gecko</span> <span class="hps">nous utilisons</span> <span class="hps">cet événement</span> <span class="hps">pour libérer</span> <span class="hps">autant de mémoire que</span> <span class="hps">nous pouvons -</span> <span class="hps">normalement</span> <span class="hps">en purgeant</span> <span class="hps">les caches internes</span> <span class="atn hps">(</span><span>images</span><span>,</span> <span class="hps">DNS</span><span>,</span> <span class="hps">sqlite</span><span>,</span> <span class="hps">etc.)</span><span>,</span> <span class="hps">l'abandon</span> <span class="hps">des actifs qui</span> <span class="hps">peuvent être recréées</span> <span class="atn hps">(</span><span>contexts</span> <span class="hps">WebGL</span> <span class="hps">par exemple</span><span>)</span> <span class="hps">et l'exécution du</span> <span class="hps">garbage collector</span> <span class="hps">et</span> <span class="hps">collecteur de cycles</span><span>.</span></span><br>
 <br>
 <span id="result_box" lang="fr"><span class="hps">Lorsqu'il rencontre</span> <span class="hps">une condition</span> <span class="hps">de mémoire</span> <span class="hps">faible</span></span> the premier <span class="short_text" id="result_box" lang="fr"><span class="hps">événement </span></span><code>memory-pressure</code> <span class="short_text" id="result_box" lang="fr"><span class="hps"> qui sera</span> <span class="hps">envoyé</span> <span class="hps">aura</span></span> the <code>low-memory</code> payload. <span id="result_box" lang="fr"><span class="hps">Si</span> <span class="hps">après un temps</span> <span class="hps">prédéfini</span> <span class="atn hps">(</span><span>5s</span><span>)</span> <span class="hps">nous sommes toujours</span> <span class="hps">dans une</span> <span class="hps">condition de mémoire</span> <span class="hps">faible un autre</span></span> <code>événement memory-pressure </code><span class="short_text" id="result_box" lang="fr"><span class="hps">sera</span> <span class="hps">tiré,</span> <span class="hps">mais cette fois avec</span> <span class="hps">le</span></span> <code>low-memory-ongoing</code> payload. <span id="result_box" lang="fr"><span class="hps">Ce</span> <span class="hps">payload est</span> <span class="hps">utilisé lorsque</span> <span class="hps">nous continuons à</span> <span class="hps">connaître des conditions</span> <span class="hps">de mémoire faible</span> <span class="hps">et nous voulons</span> <span class="hps">vider</span> <span class="hps">les caches</span> <span class="hps">et faire d'autres</span> <span class="hps">formes</span> <span class="hps">bon marché</span> <span class="hps">de la mémoire</span> <span class="hps">minimisation</span><span>,</span> <span class="hps">mais nous savons</span> <span class="hps">que les approches</span> <span class="hps">main lourde</span> <span class="hps">comme</span> <span class="hps">un</span> <span class="hps">GC</span> <span class="hps">est peu probable</span> <span class="hps">de réussir</span><span>.</span></span></p>

<h2 id="Comment_le_LMK_et_le_low_memory_notifications_travaillent_ensemble">Comment le LMK et le low memory notifications travaillent ensemble</h2>

<p><span id="result_box" lang="fr"><span class="hps">Actuellement, le</span></span> <a href="http://hg.mozilla.org/mozilla-central/file/545c35907eff/b2g/app/b2g.js#l722">seuil de memoire faible est réglé au dessus du niveau de LMK pour les applications en arrière</a>. <span id="result_box" lang="fr"><span class="hps">Donc</span> <span class="hps">l'action</span> <span class="hps">agrégée de la</span> <span class="hps">LMK</span> <span class="hps">et du low</span> <span class="hps">memory notifications </span><span class="hps">est la suivante</span> <span class="hps">lorsqu'un périphérique</span> <span class="hps">est à court de</span> <span class="hps">mémoire</span><span>:</span></span></p>

<ol>
 <li><span id="result_box" lang="fr"><span class="hps">Tuer des</span> <span class="hps">applications</span> <span class="hps">d'arrière-plan</span> <span class="hps">dans l'ordre</span> </span>least-recently-used<span lang="fr"><span>.</span></span></li>
 <li><span class="short_text" id="result_box" lang="fr"><span class="hps">Si nous ne</span> <span class="hps">libérons</span> <span class="hps">assez de mémoire</span><span>, envoyez des événements</span></span> <code>memory-pressure</code> <span class="short_text" id="result_box" lang="fr"><span class="hps">à toutes les applications</span> <span class="hps">restantes</span></span>.</li>
 <li>Si la condition persiste, renvoyer un événement <code>memory-pressure</code> chaque 5 secondes, <span id="result_box" lang="fr"><span class="hps">mais</span> <span class="hps">les marquer comme</span> <span class="hps">en cours</span> <span class="hps">de sorte que le</span> <span class="hps">GC</span> <span class="hps">/</span> <span class="hps">CC</span> <span class="hps">ne réagit</span> <span class="hps">pas à eux.</span></span></li>
 <li><span id="result_box" lang="fr"><span class="hps">Tuer des</span> <span class="hps">applications de fond</span> <span class="hps">perceptibles</span> <span class="hps">ou</span> <span class="hps">hautement prioritaires</span><span>.</span></span></li>
 <li><span id="result_box" lang="fr"><span class="hps">Tuez</span> <span class="hps">l'application du clavier</span><span>,</span> <span class="hps">si elle est</span> <span class="hps">en cours d'exécution</span><span>.</span></span></li>
 <li><span class="short_text" id="result_box" lang="fr"><span class="hps">Tuer des</span> <span class="hps">applications de premier plan</span><span>.</span></span></li>
 <li><span id="result_box" lang="fr"><span class="hps">Tuer des</span> <span class="hps">applications de premier plan</span> <span class="hps">de haute priorité</span><span>.</span></span></li>
 <li><span class="short_text" id="result_box" lang="fr"><span class="hps">Tuer</span> <span class="hps">le processus</span> <span class="hps">préallouée</span><span>.</span></span></li>
</ol>
