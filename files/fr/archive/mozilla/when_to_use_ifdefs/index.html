---
title: Quand utiliser les "ifdefs" ?
slug: Archive/Mozilla/When_To_Use_ifdefs
translation_of: Archive/Mozilla/When_To_Use_ifdefs
---
<p>La base du code Mozilla est utilisée dans de nombreux projets et produits, incluant Firefox, Thunderbird, XULRunner et bien d'autres. Ce code de base est parfois utilisé dans plusieurs projets mais des différences dans certains endroits sont parfois nécessaires. Les "ifdefs", ou instructions conditionnelles, sont alors utilisées pour obtenir un code différent.</p>
<h3 id="What_are_ifdefs" name="What_are_ifdefs">Qu'est-ce qu'un "ifdef" ?</h3>
<p><span style="line-height: inherit;">Un "ifdef" est une directive de compilation conditionnelle pour le préprocesseur qui permet de sélectionner certains bouts de code lorsque certaines conditions sont remplies. Dans ce document, le terme est utilisé en vrac pour désigner n'importe quel type de conditions qui permettent de générer différentes configurations.</span></p>
<h3 id="When_are_ifdefs_used.3F" name="When_are_ifdefs_used.3F">Quand les "ifdefs" sont utilisés ?</h3>
<p><span style="font-family: 'Lucida Grande', 'Lucida Sans Unicode', 'DejaVu Sans', Lucida, Arial, Helvetica, sans-serif; font-size: 14px; font-weight: normal; line-height: inherit;">Il existe 3 principaux cas d'utilisations dans l'arborescence de Mozilla : les ifdefs pour la partie "platform/widget"</span><span style="font-family: 'Lucida Grande', 'Lucida Sans Unicode', 'DejaVu Sans', Lucida, Arial, Helvetica, sans-serif; font-size: 14px; font-weight: normal; line-height: inherit;">, les ifdefs définissant certaines fonctionnalités et les ifdefs spécifiques à une application:</span></p>
<h4 id="Platform.2Fwidget_ifdefs" name="Platform.2Fwidget_ifdefs">ifdefs pour "Platform/widget"</h4>
<p>Le code dans Mozilla aura fréquemment besoin d'être différent pour certaines plateformes et widgets. Ces ifdefs sont pour la plupart acceptés. La seule fois où ils peuvent poser problèmes est lorsque l'on a du code d'une extension multi-plateforme ou pour la localisation: étant donné que ces codes sont téléchargés à travers plusieurs plateformes, les ifdefs spécifiques à une seule plateforme sont interdits.</p>
<p>Pour un exemple d'ifdef spécifique à une plateforme, voir <a class="external" href="http://bonsai.mozilla.org/cvsblame.cgi?file=mozilla/xpcom/ds/nsCRT.h&amp;rev=3.72&amp;mark=48-61#46" style="line-height: inherit;">nsCRT.h</a><span style="line-height: inherit;">.</span></p>
<h4 id="Feature_ifdefs" name="Feature_ifdefs">ifdefs pour les fonctionnalités (ou "feature")</h4>
<p>Le code dans Mozilla contient beaucoup de fonctionnalités pouvant être activées/désactivées via des flags dans un fichier configure. Par exemple, il est possible de désactiver une grande partie du moteur de rendu de XUL en spécifiant <code>--disable-xul </code>quand on crée une configuration pour un build. Quand on ajoute des ifdefs qui implémente ces flags de configuration, une grande attention doit être portée sur les <strong>dépendances de construction</strong> (<em>build dependencies</em>). Par exemple, XPCOM, le moteur Javascript SpiderMonkey et le moteur réseau ne connaissent rien de XUL et ne devraient avoir aucun ifdefs basé sur <code>--disable-xul</code>.</p>
<p>Un ifdef spécial mérite votre attention : "MOZ_XUL_APP". Cette variable permet de "marquer" toutes applications utilisant le "toolkit". Les ifdefs sur MOZ_XUL_APP ne sont pas acceptables pour le <a class="external" href="http://bonsai.mozilla.org/cvsblame.cgi?file=mozilla/Makefile.in&amp;rev=1.291&amp;mark=146-208#144">tier 9</a>, mais sont tolérés (et parfois même indispensable) pour les tiers suivants.</p>
<p>Pour un exemple d'ifdef gérant des caractéristiques, voir<span style="line-height: inherit;"> </span><a class="external" href="http://bonsai.mozilla.org/cvsblame.cgi?file=mozilla/layout/Makefile.in&amp;rev=1.22&amp;mark=57-59,61-63,65-67#55" style="line-height: inherit;">layout/Makefile.in</a><span style="line-height: inherit;">.</span></p>
<h4 id="Application-specific_ifdefs" name="Application-specific_ifdefs">ifdefs spécifiques aux applications</h4>
<p>Pour finir, chaque application/projet a besoin de générer différents morceaux de code. <strong>Les ifdefs liés à une application ne devraient se trouver que dans du code spécifique à cette application</strong>. C'est le ifdef le plus délicat à placer car il est souvent difficile de savoir quel code est partagé et quel code est spécifique à une application. En règle général, tout code dans le <b><a class="external" href="http://bonsai.mozilla.org/cvsblame.cgi?file=mozilla/Makefile.in&amp;rev=1.291&amp;mark=132-144#130">tier 2</a>, <a class="external" href="http://bonsai.mozilla.org/cvsblame.cgi?file=mozilla/Makefile.in&amp;rev=1.291&amp;mark=146-208#144">tier 9</a>, ou <a class="external" href="http://bonsai.mozilla.org/cvsblame.cgi?file=mozilla/Makefile.in&amp;rev=1.291&amp;mark=210-301#208">tier 50</a></b> est du code partagé et ne devrait pas contenir d'ifdef spécifique à une application. N'importe quel code dans les tiers suivants est spécifique à une application. Cette règle comporte de nombreuses exceptions dont certaines sont listées ici :</p>
<ul>
  <li>Le code dans <code>editor/ui/</code> est généré pour la suite et la version standalone de l'éditeur de texte Mozilla composer ainsi que pour thunderbird mais il est considéré comme étant du code spécifique à une application (<em>application-specific</em>).</li>
  <li>Le code dans <code>xpfe/</code> (excepté pour <code>xpfe/appshell/</code> et <code>xpfe/components/shistory/</code>) est un mélange de code "toolkit" et "application-specific". Ce code est destiné à être déplacé ailleurs (la plupart dans <code>toolkit/</code> ou <code>suite/</code>), mais pour le moment la plupart des ifdefs spécifique à une application sont autorisés car la situation est difficile à changer. Si vous souhaitez plus de détails, demander à <a>Benjamin Smedberg</a>.</li>
</ul>
<p>Pour un exemple d'ifdef spécifique à une application mauvais et qui devrait être supprimé, voir <a class="external" href="http://bonsai.mozilla.org/cvsblame.cgi?file=mozilla/toolkit/xre/nsNativeAppSupportWin.cpp&amp;rev=1.19&amp;mark=687-694#684" style="line-height: inherit;">nsNativeAppSupportWin.cpp</a><span style="line-height: inherit;">.</span></p>
<h3 id="Types_of_ifdef" name="Types_of_ifdef">Types d'<em>ifdef</em></h3>
<p>Il existe deux grands types d'ifdef : les ifdef pour le préprocesseur et les ifdefs pour le Makefile. Les ifdefs pour le préprocesseur sont généralement facile à repérer: dans du code C, C++ on les trouve avec des instructions comme #ifdef ou #if.</p>
<p>Les ifdefs dans un Makefile sont cependant plus dur à repérer et peuvent indirectement provoquer des erreurs ce qui est bien plus grave. Les ifdefs d'un Makefile sont utilisés pour construire ou non certains répertoires. Cela signifie qu'il existe des interfaces complètement différentes mais portant le même nom qui sont construites via des conditions. Par exemple (au moment de la rédaction), il existe 2 interfaces <span style="line-height: inherit;">nsIExtensionManager : {{ Source("toolkit/mozapps/extensions/public/nsIExtensionManager.idl", "toolkit version") }} et {{ Source("xpfe/components/extensions/public/nsIExtensionManager.idl", "suite version") }}. Les ifdefs du Makefile qui choisissent l'un ou l'autre ne sont pas évidents à trouver (voir {{ Source("Makefile.in") }} et {{ Source("xpfe/components/Makefile.in") }}).</span></p>
<p>Si vous introduisez un quelconque ifdef dans un makefile, veuillez demander une revue de votre code à un des mainteneurs du "build-config": <a href="/User:Benjamin_Smedberg" title="/User:Benjamin_Smedberg"><span style="line-height: inherit;">Benjamin Smedberg</span></a><span style="line-height: inherit;"> sera généralement ravi de vérifier vos changements.</span></p>
